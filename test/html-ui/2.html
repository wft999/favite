<!DOCTYPE html>
<html>
<link href="bootstrap.min.css" rel="stylesheet">
<script src="fabric.js"></script>
<body>
<div class="container" style="margin-top:20px">
   <div class="row">
      <div class="col-md-6">
        <div style="width:100%; height:384px; overflow:auto">
            <canvas id="myCanvas1" width="512" height="384"  style="border:1px solid #d3d3d3;">
                Your browser does not support the HTML5 canvas tag.
            </canvas>
        </div>
        <input type="range" id="Range1" min="0.001" max="1.0" value="1.0" step="0.01" style="display: block;margin: 20px auto;">
      </div>
      <div class="col-md-6">
        <div style="width:100%; height:384px; overflow:auto">
            <canvas id="myCanvas2" width="512" height="384"  style="border:1px solid #d3d3d3;">
                Your browser does not support the HTML5 canvas tag.
            </canvas>
        </div>
        <input type="range" id="Range2" min="0.0" max="1.0" value="1.0" step="0.0001" style="display: block;margin: 20px auto;">
        
	</div>      
   </div>
</div>

<script>
const COL_NUM = 32;
const ROW_NUM = 44;
const WIDTH = 12000;
const HEIGHT = 5000;

var rect;
var slider1 = document.getElementById("Range1");
var slider2 = document.getElementById("Range2");
var canvas1  = new fabric.Canvas('myCanvas1');
var canvas2  = new fabric.Canvas('myCanvas2');

slider2.onchange = function () {
	var zoom = canvas2.getZoom();
	var width = canvas2.getWidth();
	var height = canvas2.getHeight();
	canvas2.setZoom(slider2.value);
	canvas2.setDimensions({width:slider2.value*width/zoom,height:slider2.value*height/zoom});
}

var img1 = new fabric.Image();
img1.setSrc("file:///E:/data/TestTu-NoOffset.bmp", function(img) {
	img.set({
      left: 0,
      top: 0,
      hasControls:false,
      lockMovementX:true,
      lockMovementY:true,
      selectable:false 
	});

	var zoom = Math.max(canvas1.getWidth()/img.width,canvas1.getHeight()/img.height);
	canvas1.setZoom(zoom);
    canvas1.add(img);
    
    rect = new fabric.Rect({left:0,top:0, width: 4*img.width/COL_NUM, height: 4*img.height/ROW_NUM, opacity: 0.1});
    rect.on("modified",update);
    rect.on("deselected",function(){canvas1.setActiveObject(rect);});
    rect.cornerStyle = "circle";
    rect.cornerSize = 5;
    canvas1.add(rect);
    canvas1.setActiveObject(rect);
    update();
    
    slider1.value = zoom;
    slider1.onchange = function () {
    	canvas1.setZoom(slider1.value);
    	canvas1.setDimensions({width:img.width*slider1.value,height:img.height*slider1.value});
    };
});


function update(){
    
    var startCol = COL_NUM * rect.left/img1.width;
    var endCol = COL_NUM * (rect.left+rect.width*rect.scaleX)/img1.width;
    var startRow = ROW_NUM * rect.top/img1.height;
    var endRow = ROW_NUM * (rect.top+rect.height*rect.scaleY)/img1.height;
    var zoom = Math.max(canvas2.getWidth()/(WIDTH*(endCol-startCol)),canvas2.getHeight()/(HEIGHT*(endRow-startRow)));
    
    console.log("startCol:"+startCol+"  endCol:"+endCol+"  startRow:"+startRow+"  endRow:"+endRow+"  zoom:"+zoom+"\n");
    
    slider2.value = zoom;
    canvas2.setZoom(zoom);
    canvas2.setDimensions({width:WIDTH*(endCol-startCol)*zoom,height:HEIGHT*(endRow-startRow)*zoom});
    canvas2.clear();
    
    var cropX0 = null;
    var cropY0 = null;
    for(var col=Math.floor(startCol);col<Math.ceil(endCol);col++){
        for(var row=Math.floor(startRow);row<Math.ceil(endRow);row++){
        	
    		var left = col>Math.floor(startCol)?(col-Math.floor(startCol)-1)*WIDTH+(WIDTH-cropX0): 0;
            var top = row>Math.floor(startRow)?(row-Math.floor(startRow)-1)*HEIGHT+(HEIGHT-cropY0) : 0;
            var cropX = col>Math.floor(startCol)? 0 : (startCol-col)*WIDTH;
            var cropY = row>Math.floor(startRow)? 0 : (startRow-row)*HEIGHT;
            var width = col==Math.floor(startCol)? WIDTH-cropX : (col == Math.floor(endCol)?(endCol-col)*WIDTH:WIDTH);
            var height = row==Math.floor(startRow)? HEIGHT-cropY : (row == Math.floor(endRow)?(endRow-row)*HEIGHT:HEIGHT) ;		

            if(cropX0 == null) cropX0 = cropX;
            if(cropY0 == null) cropY0 = cropY;
            
            var img = new fabric.Image();
            img.opt = {
            		hasControls:false,
                    lockMovementX:true,
                    lockMovementY:true,
                    selectable:false,
            		left: left,
                    top: top,
                    cropX: cropX,
                    cropY: cropY,
                    width: width,
                    height: height 		
            }
            
            
            img.setSrc("file:///E:/data/JpegFile/AoiL_IP0_scan0_block"+row+".jpg", function(img) {
                img.set(img.opt);  
                canvas2.add(img);
            });
            
            console.log("col:"+col+"  row:"+row+"  left:"+left+"  top:"+top+"  cropX:"+cropX+"  cropY:"+cropY+"  width:"+width+"  height:"+height+"\n");
            
        }
    }

}

</script>

</body>
</html>
